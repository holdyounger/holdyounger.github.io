

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme="dark">



<head>
  <meta charset="UTF-8">

  <link rel="apple-touch-icon" sizes="76x76" href="https://avatars.githubusercontent.com/u/88082435?v=4">
  <link rel="icon" href="https://avatars.githubusercontent.com/u/88082435?v=4">
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="mingming">
  <meta name="keywords" content>
  
    <meta name="description" content="概述：如何使用 PDB 查找 PE 中的特定函数名的函数">
<meta property="og:type" content="article">
<meta property="og:title" content="【DbgHelp】通过PDB在PE中查找函数">
<meta property="og:url" content="https://hodlyounger.github.io/A_OS/Windows/DbgHelp/%E3%80%90DbgHelp%E3%80%91%E9%80%9A%E8%BF%87PDB%E5%9C%A8PE%E4%B8%AD%E6%9F%A5%E6%89%BE%E5%87%BD%E6%95%B0/index.html">
<meta property="og:site_name" content="oone">
<meta property="og:description" content="概述：如何使用 PDB 查找 PE 中的特定函数名的函数">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2024-08-11T16:00:00.000Z">
<meta property="article:modified_time" content="2024-08-20T09:36:28.839Z">
<meta property="article:author" content="mingming">
<meta name="twitter:card" content="summary_large_image">
  
  
  
  <title>【DbgHelp】通过PDB在PE中查找函数 - oone</title>

  <link rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css">



  <link rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css">

  <link rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css">

  <link rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css">



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css">



<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css">


<link rel="stylesheet" href="/css/main.css">


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css">
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css">
  



  
<link rel="stylesheet" href="/css/callout_blocks.css">



  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"hodlyounger.github.io","root":"/","version":"1.9.8","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false},"umami":{"src":null,"website_id":null,"domains":null,"start_time":"2024-01-01T00:00:00.000Z","token":null,"api_server":"holdyounger.github.io"}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script src="/js/utils.js"></script>
  <script src="/js/color-schema.js"></script>
  


  
<meta name="generator" content="Hexo 7.1.1"><link rel="alternate" href="/atom.xml" title="oone" type="application/atom+xml">
</head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Montarius</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax="true" style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="【DbgHelp】通过PDB在PE中查找函数"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2024-08-12 00:00" pubdate>
          2024年8月12日 凌晨
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          2.4k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          20 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">【DbgHelp】通过PDB在PE中查找函数</h1>
            
            
              <div class="markdown-body">
                
                <blockquote>
<p>概述：如何使用 PDB 查找 PE 中的特定函数名的函数</p>
</blockquote>
<span id="more"></span>
<h2 id="说明"><a class="markdownIt-Anchor" href="#说明"></a> 说明</h2>
<p>如果查找指定PE中是否声明和使用了某函数，则需要使用 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://learn.microsoft.com/zh-cn/windows/win32/api/dbghelp/">Dbghelp.h 标头 - Win32 apps | Microsoft Learn</a> 模块。</p>
<ol>
<li>
<p>如何获取 PDB 文件<br>
需要调用 symchk 从微软下载，symchk 的调用命令如下所示：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs cpp">symchk /r &lt;路径到PE文件&gt; /s SRV*&lt;本地符号存储路径&gt;*&lt;微软符号服务器路径&gt;<br>   <br># 示例<br><br>symchk /r C:\Windows\System32\notepad.exe /s SRV*C:\Symbols*http:<span class="hljs-comment">//msdl.microsoft.com/download/symbols</span><br></code></pre></td></tr></table></figure>
</li>
<li>
<p>加载  PDB 文件<br>
加载 PDB 需要调用 <code>SymLoadModuleExW</code> 加载</p>
</li>
<li>
<p>查找符号<br>
查找符号可使用 <code>SymFromNameW</code> 或者 <code>SymEnumSymbolsW</code>，区别在于 <code>SymEnumSymbolsW</code> 注册的回调可以看到是查找的函数名详细信息。</p>
</li>
</ol>
<p>下载后获取符号下载路径<br>
需要获取 PDB 文件的下载路径，大致形式如下所示，其中 <code>acppage.pdb</code>  为 PE 文件中获取的 PDB 文件名，<code>E07A9D2F9AE2077290F2627631E6C50C1</code> 为 PE 文件中获取的 GUID。</p>
<figure class="highlight moonscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs moonscript"><span class="hljs-name">d</span>:\symbols\acppage.pdb\E07A9D2F9AE2077290F2627631E6C50C1\acppage.pdb<br></code></pre></td></tr></table></figure>
<p>PE 解析简要说明，相关函数名为 <code>GetPdbFileInfo</code> ：</p>
<ol>
<li>读取 PE 中的 <code>IMAGE_DIRECTORY_ENTRY_DEBUG</code> 区</li>
<li>根据偏移获取 <code>PIMAGE_DEBUG_DIRECTORY</code></li>
<li>遍历  <code>IMAGE_DEBUG_DIRECTORY</code>，查找 <code>Type</code> 为 <code>IMAGE_DEBUG_TYPE_CODEVIEW</code> 的 <code>IMAGE_DEBUG_DIRECTORY</code></li>
<li>查看当前块标志位是否为 <code>CV_SIGNATURE_RSDS</code>(<code>SDSR</code>)  ，如果是，则通过 PCV_INFO_PDB70 解析当前内存块，读取签名和 PDB 文件名</li>
</ol>
<h2 id="代码"><a class="markdownIt-Anchor" href="#代码"></a> 代码</h2>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// FindTheSqlMagicCode.cpp : 定义控制台应用程序的入口点。</span><br><span class="hljs-comment">//</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;windows.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;strsafe.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;Dbghelp.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;shlwapi.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> comment(lib,<span class="hljs-string">&quot;Dbghelp.lib&quot;</span>)</span><br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> comment(lib,<span class="hljs-string">&quot;shlwapi.lib&quot;</span>)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CV_SIGNATURE_NB10   <span class="hljs-string">&#x27;01BN&#x27;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CV_SIGNATURE_RSDS   <span class="hljs-string">&#x27;SDSR&#x27;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> RESET   <span class="hljs-string">&quot;\033[0m&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> BLACK   <span class="hljs-string">&quot;\033[30m&quot;</span>      <span class="hljs-comment">/* Black */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> RED     <span class="hljs-string">&quot;\033[31m&quot;</span>      <span class="hljs-comment">/* Red */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> GREEN   <span class="hljs-string">&quot;\033[32m&quot;</span>      <span class="hljs-comment">/* Green */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> YELLOW  <span class="hljs-string">&quot;\033[33m&quot;</span>      <span class="hljs-comment">/* Yellow */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> BLUE    <span class="hljs-string">&quot;\033[34m&quot;</span>      <span class="hljs-comment">/* Blue */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MAGENTA <span class="hljs-string">&quot;\033[35m&quot;</span>      <span class="hljs-comment">/* Magenta */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CYAN    <span class="hljs-string">&quot;\033[36m&quot;</span>      <span class="hljs-comment">/* Cyan */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> WHITE   <span class="hljs-string">&quot;\033[37m&quot;</span>      <span class="hljs-comment">/* White */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> BOLDGREEN    <span class="hljs-string">&quot;\033[1m\033[32m&quot;</span>      <span class="hljs-comment">/* Bold Green */</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;vector&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;set&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fstream&gt;</span></span><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;<br><br><span class="hljs-comment">// CodeView header </span><br><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">CV_HEADER</span> <br>&#123;<br>	DWORD CvSignature; <span class="hljs-comment">// NBxx</span><br>	LONG  Offset;      <span class="hljs-comment">// Always 0 for NB10</span><br>&#125; * PCV_HEADER;<br><br><span class="hljs-comment">// CodeView NB10 debug information </span><br><span class="hljs-comment">// (used when debug information is stored in a PDB 2.00 file) </span><br><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">CV_INFO_PDB20</span> <br>&#123;<br>	CV_HEADER  Header; <br>	DWORD      Signature;       <span class="hljs-comment">// seconds since 01.01.1970</span><br>	DWORD      Age;             <span class="hljs-comment">// an always-incrementing value </span><br>	BYTE       PdbFileName[<span class="hljs-number">1</span>];  <span class="hljs-comment">// zero terminated string with the name of the PDB file </span><br>&#125; * PCV_INFO_PDB20;<br><br><span class="hljs-comment">// CodeView RSDS debug information </span><br><span class="hljs-comment">// (used when debug information is stored in a PDB 7.00 file) </span><br><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">CV_INFO_PDB70</span> <br>&#123;<br>	DWORD      CvSignature; <br>	GUID       Signature;       <span class="hljs-comment">// unique identifier </span><br>	DWORD      Age;             <span class="hljs-comment">// an always-incrementing value </span><br>	BYTE       PdbFileName[<span class="hljs-number">1</span>];  <span class="hljs-comment">// zero terminated string with the name of the PDB file </span><br>&#125; * PCV_INFO_PDB70;<br><br><br><span class="hljs-function">LPBYTE <span class="hljs-title">GetRVAOffset</span><span class="hljs-params">(LPBYTE pBuffer, DWORD dwVirtualOffset)</span>  </span><br><span class="hljs-function"></span>&#123;<br>	PIMAGE_DOS_HEADER pDosHeader = (PIMAGE_DOS_HEADER)pBuffer;<br>	PIMAGE_NT_HEADERS32  pNtHeader32 = (PIMAGE_NT_HEADERS32)(pBuffer + pDosHeader-&gt;e_lfanew);<br>	PIMAGE_NT_HEADERS64  pNtHeader64 = (PIMAGE_NT_HEADERS64)(pBuffer + pDosHeader-&gt;e_lfanew);<br>	BOOL bIsX64 = pNtHeader32-&gt;OptionalHeader.Magic == IMAGE_NT_OPTIONAL_HDR64_MAGIC;<br><br>	<span class="hljs-type">int</span> nSectionNum = bIsX64 ? pNtHeader64-&gt;FileHeader.NumberOfSections : pNtHeader32-&gt;FileHeader.NumberOfSections;<br>	PIMAGE_SECTION_HEADER pSection = (PIMAGE_SECTION_HEADER)(pBuffer + pDosHeader-&gt;e_lfanew + (bIsX64 ? <span class="hljs-built_in">sizeof</span>(IMAGE_NT_HEADERS64) : <span class="hljs-built_in">sizeof</span>(IMAGE_NT_HEADERS32)));<br><br>	<span class="hljs-comment">// search for absolute offset</span><br>	<span class="hljs-keyword">for</span>( <span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; nSectionNum; i++)<br>	&#123;<br>		DWORD dwStart = pSection-&gt;VirtualAddress;  <br>		<span class="hljs-keyword">if</span>( dwStart &lt;= dwVirtualOffset &amp;&amp; dwVirtualOffset &lt; dwStart + pSection-&gt;SizeOfRawData)&#123;  <br>			<span class="hljs-keyword">return</span> pBuffer + pSection-&gt;PointerToRawData + (dwVirtualOffset - dwStart);  <br>		&#125;<br>		pSection++;<br>	&#125;<br><br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;  <br>&#125; <br><br><span class="hljs-function">DWORD <span class="hljs-title">GetImageSize</span><span class="hljs-params">(LPBYTE pBuffer, BOOL&amp; bIsX64)</span>  </span><br><span class="hljs-function"></span>&#123;<br>	PIMAGE_DOS_HEADER pDosHeader = (PIMAGE_DOS_HEADER)pBuffer;<br>	PIMAGE_NT_HEADERS32  pNtHeader32 = (PIMAGE_NT_HEADERS32)(pBuffer + pDosHeader-&gt;e_lfanew);<br>	PIMAGE_NT_HEADERS64  pNtHeader64 = (PIMAGE_NT_HEADERS64)(pBuffer + pDosHeader-&gt;e_lfanew);<br>	bIsX64 = pNtHeader32-&gt;OptionalHeader.Magic == IMAGE_NT_OPTIONAL_HDR64_MAGIC;<br><br>	DWORD SizeOfImage = bIsX64 ? pNtHeader64-&gt;OptionalHeader.SizeOfImage: pNtHeader32-&gt;OptionalHeader.SizeOfImage;<br><br>	<span class="hljs-keyword">return</span> SizeOfImage;  <br>&#125; <br><br><span class="hljs-function">WCHAR*  <span class="hljs-title">CharToWchar</span><span class="hljs-params">(CHAR* sSour)</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-type">size_t</span> len = <span class="hljs-built_in">strlen</span>(sSour) + <span class="hljs-number">1</span>;<br>	<span class="hljs-type">size_t</span> converted = <span class="hljs-number">0</span>;<br>	WCHAR *wzDest = <span class="hljs-literal">NULL</span>;<br>	wzDest = (WCHAR*)<span class="hljs-keyword">new</span> WCHAR[len];<br>	<span class="hljs-built_in">mbstowcs_s</span>(&amp;converted, wzDest, len, sSour, _TRUNCATE);<br>	<span class="hljs-keyword">return</span> wzDest;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">char</span>*  <span class="hljs-title">WCharToChar</span><span class="hljs-params">(WCHAR* wzSour)</span></span><br><span class="hljs-function"></span>&#123;<br>	ULONG ulLength = <span class="hljs-number">0</span>;<br>	<span class="hljs-type">char</span>* szDest = <span class="hljs-literal">NULL</span>;<br><br>	<span class="hljs-keyword">if</span> (wzSour != <span class="hljs-literal">NULL</span>)<br>	&#123;<br>		ulLength = <span class="hljs-built_in">WideCharToMultiByte</span>(CP_ACP,<span class="hljs-literal">NULL</span>, wzSour,<span class="hljs-number">-1</span>,<span class="hljs-literal">NULL</span>,<span class="hljs-number">0</span>,<span class="hljs-literal">NULL</span>,FALSE);<br>		szDest = <span class="hljs-keyword">new</span> <span class="hljs-type">char</span>[ulLength + <span class="hljs-number">1</span>];<br>		<span class="hljs-keyword">if</span> (szDest == <span class="hljs-literal">NULL</span>)<br>		&#123;<br>			<span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>		&#125;<br>		<span class="hljs-built_in">memset</span>(szDest, <span class="hljs-number">0</span>, ulLength + <span class="hljs-number">1</span>);<br>		<span class="hljs-built_in">WideCharToMultiByte</span>(CP_OEMCP, <span class="hljs-literal">NULL</span>, wzSour, <span class="hljs-number">-1</span>, szDest, ulLength, <span class="hljs-literal">NULL</span>, FALSE);<br>	&#125;<br>	<span class="hljs-keyword">return</span> szDest;<br>&#125;<br><br><br><span class="hljs-function">BOOL <span class="hljs-title">GetPdbFileInfo</span><span class="hljs-params">(LPCWSTR lpszFilePath</span></span><br><span class="hljs-params"><span class="hljs-function">					, LPWSTR szPdbFileName</span></span><br><span class="hljs-params"><span class="hljs-function">					, DWORD dwPdbFileNameCch</span></span><br><span class="hljs-params"><span class="hljs-function">					, LPWSTR szPdbGuid</span></span><br><span class="hljs-params"><span class="hljs-function">					, DWORD dwPdbGuidCch</span></span><br><span class="hljs-params"><span class="hljs-function">					, LPWSTR szChecksum</span></span><br><span class="hljs-params"><span class="hljs-function">					, DWORD dwChecksumCch</span></span><br><span class="hljs-params"><span class="hljs-function">					)</span></span><br><span class="hljs-function"></span>&#123;<br><br>	DWORD dwTotalRead = <span class="hljs-number">0</span>, dwRead = <span class="hljs-number">0</span>;<br>	DWORD dwSize = <span class="hljs-number">0</span>;<br>	BOOL bFound = FALSE;<br>	HANDLE hFile = INVALID_HANDLE_VALUE;<br>	LPBYTE pBuffer = <span class="hljs-literal">NULL</span>;<br>	<span class="hljs-keyword">do</span><br>	&#123;<br>		<span class="hljs-comment">// read the file into memory</span><br>		HANDLE hFile = ::<span class="hljs-built_in">CreateFileW</span>( lpszFilePath<br>			, GENERIC_READ<br>			, FILE_SHARE_READ | FILE_SHARE_WRITE | FILE_SHARE_DELETE<br>			, <span class="hljs-literal">NULL</span><br>			, OPEN_EXISTING<br>			, FILE_ATTRIBUTE_NORMAL<br>			, <span class="hljs-literal">NULL</span><br>			);<br>		<span class="hljs-keyword">if</span>( hFile == INVALID_HANDLE_VALUE )<br>		&#123;<br>			<span class="hljs-keyword">break</span>;<br>		&#125;<br><br>		dwSize = <span class="hljs-built_in">GetFileSize</span>( hFile, <span class="hljs-literal">NULL</span>);<br>		<span class="hljs-keyword">if</span>( dwSize &lt; <span class="hljs-number">4096</span> ) <span class="hljs-comment">// hardcode for file size limit</span><br>		&#123;<br>			<span class="hljs-keyword">break</span>;<br>		&#125;<br><br>		pBuffer = (LPBYTE)<span class="hljs-built_in">HeapAlloc</span>( <span class="hljs-built_in">GetProcessHeap</span>(), HEAP_ZERO_MEMORY, dwSize);<br>		<span class="hljs-keyword">if</span>(!pBuffer)<br>		&#123;<br>			<span class="hljs-keyword">break</span>;<br>		&#125;<br><br><br><br>		<span class="hljs-keyword">while</span>( dwTotalRead &lt; dwSize &amp;&amp;<br>			<span class="hljs-built_in">ReadFile</span>( hFile, pBuffer + dwTotalRead, dwSize - dwTotalRead, &amp;dwRead, <span class="hljs-literal">NULL</span>) )<br>		&#123;<br>			dwTotalRead += dwRead;<br>		&#125;<br><br><br>	&#125;<span class="hljs-keyword">while</span>(<span class="hljs-number">0</span>);<br><br>	<span class="hljs-keyword">if</span>(hFile != INVALID_HANDLE_VALUE)<br>	&#123;<br>		::<span class="hljs-built_in">CloseHandle</span>(hFile);<br>	&#125;<br><br>	<span class="hljs-keyword">if</span>(pBuffer == <span class="hljs-literal">NULL</span>)<br>	&#123;<br>		<span class="hljs-keyword">return</span> FALSE;<br>	&#125;<br><br>	<span class="hljs-keyword">if</span>(dwTotalRead != dwSize)<br>	&#123; <br>		<span class="hljs-keyword">if</span>(pBuffer)<br>		&#123;<br>			<span class="hljs-built_in">HeapFree</span>( <span class="hljs-built_in">GetProcessHeap</span>(), <span class="hljs-number">0</span>, pBuffer);<br>		&#125;<br>		<span class="hljs-keyword">return</span> FALSE;<br>	&#125;<br><br>	LPWSTR lpszpdbInfo = <span class="hljs-literal">NULL</span>;<br><br>	<span class="hljs-comment">// locate the DEBUG section</span><br>	PIMAGE_DOS_HEADER pDosHeader = (PIMAGE_DOS_HEADER)pBuffer;<br>	<span class="hljs-keyword">if</span>( pDosHeader-&gt;e_magic == IMAGE_DOS_SIGNATURE )<br>	&#123;<br>		PIMAGE_DATA_DIRECTORY pDataDic;<br>		PIMAGE_NT_HEADERS32  pNtHeader32 = (PIMAGE_NT_HEADERS32)(pBuffer + pDosHeader-&gt;e_lfanew);<br>		PIMAGE_NT_HEADERS64  pNtHeader64 = (PIMAGE_NT_HEADERS64)(pBuffer + pDosHeader-&gt;e_lfanew);<br>		<span class="hljs-keyword">if</span>( pNtHeader32-&gt;Signature == IMAGE_NT_SIGNATURE )<br>		&#123;<br>			BOOL bIsX64 = pNtHeader32-&gt;OptionalHeader.Magic == IMAGE_NT_OPTIONAL_HDR64_MAGIC;<br>			<span class="hljs-keyword">if</span>( !bIsX64 )<br>				pDataDic = &amp;pNtHeader32-&gt;OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_DEBUG];<br>			<span class="hljs-keyword">else</span><br>				pDataDic = &amp;pNtHeader64-&gt;OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_DEBUG];<br><br><br>			<span class="hljs-keyword">if</span>( pDataDic &amp;&amp; pDataDic-&gt;Size &gt; <span class="hljs-number">0</span> )<br>			&#123;<br>				<span class="hljs-comment">//The number of entries in the debug directory can be obtained by dividing the size of the debug directory (as specified in the optional header’s data directory entry) by the size of IMAGE_DEBUG_DIRECTORY structure.</span><br>				<span class="hljs-type">int</span> nNumberOfEntries = pDataDic-&gt;Size / <span class="hljs-built_in">sizeof</span>(IMAGE_DEBUG_DIRECTORY);<br>				PIMAGE_DEBUG_DIRECTORY pDebugDic = (PIMAGE_DEBUG_DIRECTORY)<span class="hljs-built_in">GetRVAOffset</span>( pBuffer, pDataDic-&gt;VirtualAddress);<br><br>				<span class="hljs-keyword">for</span>( <span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; nNumberOfEntries &amp;&amp; !bFound ; i++)<br>				&#123;<br>					<span class="hljs-comment">// CodeView debug information (stored in the executable) or Program Database debug information (stored in PDB file)</span><br>					<span class="hljs-keyword">if</span>( pDebugDic-&gt;Type == IMAGE_DEBUG_TYPE_CODEVIEW )<br>					&#123;<br>						LPBYTE pDebugData = pBuffer + pDebugDic-&gt;PointerToRawData;<br>						DWORD dwCVSignature = *(LPDWORD)pDebugData; <br>						<span class="hljs-keyword">if</span>( dwCVSignature == CV_SIGNATURE_RSDS  )<br>						&#123;<br>							PCV_INFO_PDB70 pCvInfo = (PCV_INFO_PDB70)pDebugData; <br>							<span class="hljs-built_in">StringCbPrintfW</span>( szPdbGuid, dwPdbFileNameCch<br>								, <span class="hljs-string">L&quot;%08X%04X%04X%02X%02X%02X%02X%02X%02X%02X%02X%d&quot;</span><br>								, pCvInfo-&gt;Signature.Data1<br>								, pCvInfo-&gt;Signature.Data2<br>								, pCvInfo-&gt;Signature.Data3<br>								, pCvInfo-&gt;Signature.Data4[<span class="hljs-number">0</span>]<br>							, pCvInfo-&gt;Signature.Data4[<span class="hljs-number">1</span>]<br>							, pCvInfo-&gt;Signature.Data4[<span class="hljs-number">2</span>]<br>							, pCvInfo-&gt;Signature.Data4[<span class="hljs-number">3</span>]<br>							, pCvInfo-&gt;Signature.Data4[<span class="hljs-number">4</span>]<br>							, pCvInfo-&gt;Signature.Data4[<span class="hljs-number">5</span>]<br>							, pCvInfo-&gt;Signature.Data4[<span class="hljs-number">6</span>]<br>							, pCvInfo-&gt;Signature.Data4[<span class="hljs-number">7</span>]<br>							, pCvInfo-&gt;Age<br>								);<br><br>							lpszpdbInfo = <span class="hljs-built_in">CharToWchar</span>((LPSTR)pCvInfo-&gt;PdbFileName);<br>							<span class="hljs-built_in">StringCbCopy</span>( szPdbFileName, dwPdbFileNameCch, lpszpdbInfo);<br>							<span class="hljs-keyword">delete</span>[]lpszpdbInfo;<br><br>							<span class="hljs-keyword">if</span>( bIsX64 )<br>							&#123;<br>								<span class="hljs-built_in">StringCbPrintfW</span>( szChecksum, dwChecksumCch<br>									, <span class="hljs-string">L&quot;%x%x&quot;</span><br>									, pNtHeader64-&gt;FileHeader.TimeDateStamp<br>									, pNtHeader64-&gt;OptionalHeader.SizeOfImage<br>									);<br>							&#125;<br>							<span class="hljs-keyword">else</span><br>							&#123;<br>								<span class="hljs-built_in">StringCbPrintfW</span>( szChecksum, dwChecksumCch<br>									, <span class="hljs-string">L&quot;%x%x&quot;</span><br>									, pNtHeader32-&gt;FileHeader.TimeDateStamp<br>									, pNtHeader32-&gt;OptionalHeader.SizeOfImage<br>									);<br>							&#125;<br><br>							bFound = TRUE;<br>						&#125;<br>					&#125;<br><br>					pDebugDic++;<br>				&#125;<br>			&#125;<br>		&#125;<br>	&#125;<br><br>	<span class="hljs-built_in">HeapFree</span>( <span class="hljs-built_in">GetProcessHeap</span>(), <span class="hljs-number">0</span>, pBuffer);<br><br>	<span class="hljs-keyword">return</span> bFound;<br>&#125;<br><br><br><span class="hljs-function">DWORD  <span class="hljs-title">RunTheSymchk</span><span class="hljs-params">(LPWSTR szCommandLine)</span></span><br><span class="hljs-function"></span>&#123;<br>	DWORD dwMbrId = <span class="hljs-number">0</span>;<br><br>	STARTUPINFO si;<br>	PROCESS_INFORMATION pi;<br>	<span class="hljs-built_in">ZeroMemory</span>(&amp;si, <span class="hljs-built_in">sizeof</span>(si));<br>	si.cb = <span class="hljs-built_in">sizeof</span>(si);<br>	<span class="hljs-built_in">ZeroMemory</span>(&amp;pi, <span class="hljs-built_in">sizeof</span>(pi));<br><br><br>	BOOL bResult = ::<span class="hljs-built_in">CreateProcess</span>(<span class="hljs-literal">NULL</span>,szCommandLine , <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, FALSE, <span class="hljs-number">0</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, &amp;si, &amp;pi);<br><br>	<span class="hljs-keyword">if</span> (!bResult)<br>		<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>	<span class="hljs-keyword">if</span> (<span class="hljs-built_in">WaitForSingleObject</span>(pi.hProcess,<span class="hljs-number">180</span>*<span class="hljs-number">1000</span>) == WAIT_TIMEOUT)<br>		<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>	<span class="hljs-type">int</span> dwCode = <span class="hljs-number">0</span>;<br>	<span class="hljs-keyword">if</span> (!<span class="hljs-built_in">GetExitCodeProcess</span>(pi.hProcess,(DWORD*)&amp;dwCode))<br>	&#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>	&#125;<br><br>	<span class="hljs-built_in">CloseHandle</span>(pi.hProcess);<br>	<span class="hljs-built_in">CloseHandle</span>(pi.hThread);<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>&#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> WINDBG_INSTALLPATH <span class="hljs-string">L&quot;D:\\Windows Kits\\10\\Debuggers\\x64&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> NT_SYMBOLS_DIR <span class="hljs-string">L&quot;d:\\symbols\\&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> NT_SYMBOLS_FORMATS <span class="hljs-string">L&quot;SRV*%ws*http://msdl.microsoft.com/download/symbols&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> TEST_PATH <span class="hljs-string">L&quot;D:\\Documents\\D_IDA\\SHClient\\SHClient.exe&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SYMCHCKCMD_LINE_FORMATS <span class="hljs-string">L&quot;%ws\\symchk.exe  /r  %ws  /s %ws&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> LDR_IS_DATAFILE(handle)      (((ULONG_PTR)(handle)) &amp;  (ULONG_PTR)1)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> LDR_IS_IMAGEMAPPING(handle)  (((ULONG_PTR)(handle)) &amp; (ULONG_PTR)2)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> LDR_IS_RESOURCE(handle)      (LDR_IS_IMAGEMAPPING(handle) || LDR_IS_DATAFILE(handle))</span><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> 0</span><br><span class="hljs-comment">// #define SYMBOL_NAME  L&quot;PsspDumpThread&quot;</span><br><span class="hljs-comment">// #define SYMBOL_NAME  L&quot;DownloadAndStagePayloads&quot;</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SYMBOL_NAME  <span class="hljs-string">L&quot;*Payload*&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ENUM_PATH  <span class="hljs-string">L&quot;D:\\Documents\\TestScanPath&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ENEABLE_DEEP_CALL 1</span><br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SYMBOL_NAME  <span class="hljs-string">L&quot;*Payload*&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ENUM_PATH  <span class="hljs-string">L&quot;C:\\Windows\\System32&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ENEABLE_DEEP_CALL 1</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-comment">// PSYM_ENUMERATESYMBOLS_CALLBACKW PsymEnumeratesymbolsCallback;</span><br><br><br><span class="hljs-function"><span class="hljs-type">void</span>* <span class="hljs-title">GetNtdllBase</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-meta">#<span class="hljs-keyword">if</span> defined(_WIN64)</span><br>	ULONG64 peb = __readgsqword(<span class="hljs-number">0x60</span>);<br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br>	ULONG64 peb = __readfsdword(<span class="hljs-number">0x30</span>);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>	ULONG64 ldr = *(ULONG64*)(peb + <span class="hljs-number">0x18</span>);<br>	PLIST_ENTRY modlist = *(PLIST_ENTRY*)(ldr + <span class="hljs-number">0x10</span>); <span class="hljs-comment">// 第二个加载的 dll 就是 ntdll</span><br>	<span class="hljs-keyword">return</span> *(<span class="hljs-type">void</span>**)((ULONG64)modlist-&gt;Flink + <span class="hljs-number">0x30</span>); <span class="hljs-comment">// 获取第二个 listEntry 之后，再获取</span><br>&#125;<br><br>vector&lt;std::pair&lt;wstring, wstring&gt;&gt; g_FindReslt;<br><span class="hljs-function">BOOL CALLBACK <span class="hljs-title">PsymEnumeratesymbolsCallback</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">	_In_ PSYMBOL_INFOW pSymInfo,</span></span><br><span class="hljs-params"><span class="hljs-function">	_In_ ULONG SymbolSize,</span></span><br><span class="hljs-params"><span class="hljs-function">	_In_opt_ PVOID UserContext</span></span><br><span class="hljs-params"><span class="hljs-function">)</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-built_in">wprintf</span>(GREEN <span class="hljs-string">L&quot;%s-&gt;%s, Size:%d\n&quot;</span> WHITE, (WCHAR*)UserContext, pSymInfo-&gt;Name, SymbolSize);<br><br>	g_FindReslt.<span class="hljs-built_in">emplace_back</span>(std::<span class="hljs-built_in">make_pair</span>&lt;wstring, wstring&gt;((WCHAR*)UserContext, pSymInfo-&gt;Name));<br><br>	<span class="hljs-keyword">return</span> TRUE;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">IsExeOrDll</span><span class="hljs-params">(<span class="hljs-type">const</span> WCHAR* path)</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-type">const</span> WCHAR* patterns[] = &#123; <span class="hljs-string">L&quot;*.exe&quot;</span>, <span class="hljs-string">L&quot;*.dll&quot;</span>, <span class="hljs-literal">NULL</span> &#125;;<br><span class="hljs-meta">#<span class="hljs-keyword">if</span> 0</span><br>	<span class="hljs-keyword">if</span> (<span class="hljs-built_in">PathMatchSpecW</span>(path, patterns[<span class="hljs-number">0</span>]) == TRUE)<br>		<span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>	<span class="hljs-keyword">if</span> (<span class="hljs-built_in">PathMatchSpecW</span>(path, patterns[<span class="hljs-number">1</span>]) == TRUE)<br>		<span class="hljs-keyword">return</span> <span class="hljs-number">2</span>;<br>	<span class="hljs-keyword">return</span>  <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">int</span> g_idx = <span class="hljs-number">0</span>;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">FindAllDlls</span><span class="hljs-params">(<span class="hljs-type">const</span> WCHAR* Path, <span class="hljs-type">int</span> iDeep)</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-keyword">if</span> (iDeep &gt; <span class="hljs-number">6</span>)<br>	&#123;<br>		<span class="hljs-keyword">return</span>;<br>	&#125;<br><br>	WCHAR TargetPath[MAX_PATH] = &#123;&#125;;<br>	WCHAR szTempPath[MAX_PATH] = &#123; <span class="hljs-number">0</span> &#125;;<br>	LPCWSTR lpszFilePath = TEST_PATH;<br>	<span class="hljs-comment">//仅测试用 大量字符串申请用堆而不是栈</span><br>	DWORD dwLastError = <span class="hljs-number">0</span>;<br>	DWORD ModuleSize = <span class="hljs-number">0</span>;<br>	WCHAR szPdbFileName[MAX_PATH] = &#123; <span class="hljs-number">0</span> &#125;;<br>	WCHAR szPdbGuid[MAX_PATH] = &#123; <span class="hljs-number">0</span> &#125;;<br>	WCHAR szChecksum[MAX_PATH] = &#123; <span class="hljs-number">0</span> &#125;;<br>	WCHAR szCommandLine[MAX_PATH] = &#123; <span class="hljs-number">0</span> &#125;;<br>	WCHAR szNtSymbolUrl[MAX_PATH] = &#123; <span class="hljs-number">0</span> &#125;;<br>	WCHAR szPdbSymbolPath[MAX_PATH] = &#123; <span class="hljs-number">0</span> &#125;;<br>	LPSTR lpszPdbPath = <span class="hljs-literal">NULL</span>;<br>	WCHAR szSymbolName[MAX_SYM_NAME];<br>	DWORD dwSizeOfSymbol = <span class="hljs-built_in">sizeof</span>(SYMBOL_INFOW) + MAX_SYM_NAME * <span class="hljs-built_in">sizeof</span>(WCHAR);<br>	PBYTE pBuffer = <span class="hljs-keyword">new</span> BYTE[dwSizeOfSymbol];<br>	PSYMBOL_INFOW pSymbol = (PSYMBOL_INFOW)pBuffer;<br>	HMODULE hModuleBase = <span class="hljs-literal">NULL</span>;<br>	PBYTE pModuleBase = <span class="hljs-literal">NULL</span>;<br>	PBYTE pSymAdr = <span class="hljs-literal">NULL</span>;<br>	PBYTE lpDestCall = <span class="hljs-literal">NULL</span>;<br>	LPWSTR lpszCFile = <span class="hljs-literal">NULL</span>;<br>	MEMORY_BASIC_INFORMATION MbInfo = &#123; <span class="hljs-number">0</span> &#125;;<br><br>	BOOL bIsX64 = FALSE;<br>	<span class="hljs-built_in">StringCbCopy</span>(TargetPath, MAX_PATH, Path);<br>	<span class="hljs-built_in">StringCbCat</span>(TargetPath, MAX_PATH, <span class="hljs-string">L&quot;\\*.*&quot;</span>);<br><br>	WIN32_FIND_DATA fd = &#123; <span class="hljs-number">0</span> &#125;;<br>	HANDLE hFind = <span class="hljs-built_in">FindFirstFile</span>(TargetPath, &amp;fd);<br>	<span class="hljs-keyword">do</span><br>	&#123;<br><br>		<span class="hljs-keyword">if</span> (<span class="hljs-built_in">StrCmpCW</span>(<span class="hljs-string">L&quot;AppVStreamingUX.exe&quot;</span>, fd.cFileName) == <span class="hljs-number">0</span>)<br>		&#123;<br>			cout &lt;&lt; endl;<br>		&#125;<br>		<span class="hljs-keyword">if</span> (<span class="hljs-built_in">StrCmpCW</span>(<span class="hljs-string">L&quot;SIHClient.exe&quot;</span>, fd.cFileName) == <span class="hljs-number">0</span>)<br>		&#123;<br>			cout &lt;&lt; endl;<br>		&#125;<br><br>		<span class="hljs-keyword">if</span> (hFind != INVALID_HANDLE_VALUE)<br>		&#123;<br>			<span class="hljs-keyword">if</span> (!(fd.dwFileAttributes &amp; FILE_ATTRIBUTE_DIRECTORY))<br>			&#123;<br>				<span class="hljs-type">int</span> iFileExFlag = <span class="hljs-number">0</span>;<br>				<span class="hljs-type">const</span> WCHAR* filename = fd.cFileName;<br><br><br>				<span class="hljs-keyword">if</span> (!(iFileExFlag = <span class="hljs-built_in">IsExeOrDll</span>(filename)))<br>				&#123;<br>					<span class="hljs-keyword">continue</span>;<br>				&#125;<br><br>				szTempPath[<span class="hljs-number">0</span>] = <span class="hljs-number">0</span>;<br>				<span class="hljs-built_in">StringCbCopy</span>(szTempPath, MAX_PATH, Path);<br>				<span class="hljs-comment">// szTempPath[wcslen(szTempPath)] = 0;</span><br>				<span class="hljs-built_in">PathAppend</span>(szTempPath, fd.cFileName);<br>				lpszFilePath = szTempPath;<br>				<span class="hljs-built_in">GetPdbFileInfo</span>(lpszFilePath, szPdbFileName, MAX_PATH, szPdbGuid, MAX_PATH, szChecksum, MAX_PATH);<br><br>				<span class="hljs-built_in">StringCbPrintf</span>(szNtSymbolUrl, MAX_PATH * <span class="hljs-built_in">sizeof</span>(WCHAR), NT_SYMBOLS_FORMATS, NT_SYMBOLS_DIR);<br>				<span class="hljs-built_in">StringCbPrintf</span>(szCommandLine, MAX_PATH * <span class="hljs-built_in">sizeof</span>(WCHAR), SYMCHCKCMD_LINE_FORMATS, WINDBG_INSTALLPATH, lpszFilePath, szNtSymbolUrl);<br><br>				<span class="hljs-built_in">StringCbCopy</span>(szPdbSymbolPath, MAX_PATH * <span class="hljs-built_in">sizeof</span>(WCHAR), NT_SYMBOLS_DIR);<br>				<span class="hljs-built_in">StringCbCat</span>(szPdbSymbolPath, MAX_PATH * <span class="hljs-built_in">sizeof</span>(WCHAR), szPdbFileName);<br>				<span class="hljs-built_in">StringCbCat</span>(szPdbSymbolPath, MAX_PATH * <span class="hljs-built_in">sizeof</span>(WCHAR), <span class="hljs-string">L&quot;\\&quot;</span>);<br>				<span class="hljs-built_in">StringCbCat</span>(szPdbSymbolPath, MAX_PATH * <span class="hljs-built_in">sizeof</span>(WCHAR), szPdbGuid);<br>				<span class="hljs-built_in">StringCbCat</span>(szPdbSymbolPath, MAX_PATH * <span class="hljs-built_in">sizeof</span>(WCHAR), <span class="hljs-string">L&quot;\\&quot;</span>);<br>				<span class="hljs-built_in">StringCbCat</span>(szPdbSymbolPath, MAX_PATH * <span class="hljs-built_in">sizeof</span>(WCHAR), szPdbFileName);<br>				<span class="hljs-comment">// if (iFileExFlag == 1)</span><br>				&#123;<br>					std::cout &lt;&lt; (iFileExFlag == <span class="hljs-number">1</span> ? MAGENTA : CYAN);<br>					<span class="hljs-built_in">wprintf</span>(<span class="hljs-string">L&quot;%d Load:%ws\r\n&quot;</span>, g_idx++, lpszFilePath);<br>					std::cout &lt;&lt; WHITE;<br>				&#125;<br>				hModuleBase = <span class="hljs-built_in">LoadLibraryExW</span>(lpszFilePath, <span class="hljs-literal">NULL</span>, LOAD_LIBRARY_AS_IMAGE_RESOURCE);<br>				pModuleBase = (PBYTE)hModuleBase;<br><br>				BOOL bNeedUnload = TRUE;<br>				<span class="hljs-keyword">if</span> (<span class="hljs-built_in">GetModuleHandle</span>(filename))<br>				&#123;<br>					bNeedUnload = FALSE;<br>				&#125;<br><br>				<span class="hljs-keyword">if</span> (<span class="hljs-built_in">LDR_IS_RESOURCE</span>(hModuleBase))<br>				&#123;<br>					ULONG_PTR  ulTemp = (ULONG_PTR)hModuleBase;<br>					ulTemp = ulTemp - <span class="hljs-number">2</span>;<br>					pModuleBase = (PBYTE)ulTemp;<br>				&#125;<br><br>				<span class="hljs-keyword">if</span> (pModuleBase == <span class="hljs-literal">NULL</span>)<br>				&#123;<br>					<span class="hljs-keyword">continue</span>;<br>				&#125;<br><br>				ModuleSize = <span class="hljs-built_in">GetImageSize</span>((LPBYTE)pModuleBase, bIsX64);<br><span class="hljs-meta">#<span class="hljs-keyword">if</span> 0</span><br>				<span class="hljs-keyword">if</span> (!bIsX64)<br>				&#123;<br>					<span class="hljs-built_in">FreeLibrary</span>(hModuleBase);<br>					<span class="hljs-keyword">continue</span>;<br>				&#125;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>				<span class="hljs-keyword">if</span> (!<span class="hljs-built_in">PathFileExists</span>(szPdbSymbolPath))<br>				&#123;<br>					<span class="hljs-comment">// RunTheSymchk(szCommandLine);</span><br>				&#125;<br><br>				DWORD64 baseAddr = <span class="hljs-number">0</span>;<br>				lpszPdbPath = <span class="hljs-built_in">WCharToChar</span>(szPdbSymbolPath);<br><br>				<span class="hljs-comment">// if (!SymLoadModule64(GetCurrentProcess(), NULL, (STRSAFE_LPCSTR)lpszPdbPath, NULL, (DWORD64)pModuleBase, ModuleSize))</span><br>				<span class="hljs-keyword">if</span> (!(baseAddr = <span class="hljs-built_in">SymLoadModuleExW</span>(<span class="hljs-built_in">GetCurrentProcess</span>(), <span class="hljs-literal">NULL</span>, (PCWSTR)szPdbSymbolPath, <span class="hljs-literal">NULL</span>, (DWORD64)pModuleBase, ModuleSize, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>)))<br>				&#123;<br>					dwLastError = <span class="hljs-built_in">GetLastError</span>();<br>					<span class="hljs-keyword">delete</span>[] lpszPdbPath;<br>					<span class="hljs-built_in">FreeLibrary</span>(hModuleBase);<br>					<span class="hljs-built_in">SymUnloadModule</span>(<span class="hljs-built_in">GetCurrentProcess</span>(), (DWORD64)pModuleBase);<br>					<span class="hljs-keyword">continue</span>;<br>				&#125;<br><br>				<span class="hljs-keyword">delete</span>[] lpszPdbPath;<br><br><br>				pSymbol-&gt;SizeOfStruct = <span class="hljs-built_in">sizeof</span>(SYMBOL_INFO);;<br>				pSymbol-&gt;MaxNameLen = MAX_SYM_NAME;<br>				<span class="hljs-keyword">if</span> (!<span class="hljs-built_in">SymFromNameW</span>(<span class="hljs-built_in">GetCurrentProcess</span>(), SYMBOL_NAME, pSymbol))<br>				&#123;<br>					dwLastError = <span class="hljs-built_in">GetLastError</span>();<br>					<span class="hljs-built_in">FreeLibrary</span>(hModuleBase);<br>					<span class="hljs-keyword">continue</span>;<br>				&#125;<br><br>				<span class="hljs-keyword">if</span> (!<span class="hljs-built_in">SymEnumSymbolsW</span>(<span class="hljs-built_in">GetCurrentProcess</span>(), baseAddr, SYMBOL_NAME, PsymEnumeratesymbolsCallback, (PVOID)lpszFilePath))<br>				&#123;<br>					dwLastError = <span class="hljs-built_in">GetLastError</span>();<br>					<span class="hljs-built_in">FreeLibrary</span>(hModuleBase);<br>					<span class="hljs-keyword">continue</span>;<br>				&#125;<br><br>				<span class="hljs-comment">// g_FindReslt.emplace_back(lpszFilePath);</span><br>				<span class="hljs-comment">// wprintf(MAGENTA L&quot;FileX64:%ws\r\n&quot; WHITE, lpszFilePath);</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> 0</span><br>				pSymAdr = (PBYTE)pSymbol-&gt;Address;<br><br>				<span class="hljs-keyword">if</span> (<span class="hljs-built_in">VirtualQuery</span>(pSymAdr, &amp;MbInfo, <span class="hljs-built_in">sizeof</span>(MbInfo)) == <span class="hljs-built_in">sizeof</span>(MbInfo))<br>				&#123;<br>					<span class="hljs-keyword">if</span> (MbInfo.State != MEM_COMMIT)<br>					&#123;<br>						dwLastError = <span class="hljs-built_in">GetLastError</span>();<br>						<span class="hljs-built_in">FreeLibrary</span>(hModuleBase);<br>						<span class="hljs-keyword">continue</span>;<br>					&#125;<br>				&#125;<br><br>				<span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x150</span>; i++)<br>				&#123;<br>					<span class="hljs-keyword">if</span> (*(pSymAdr + i) == <span class="hljs-number">0x4c</span> &amp;&amp; *(pSymAdr + i + <span class="hljs-number">1</span>) == <span class="hljs-number">0x8d</span> &amp;&amp; *(pSymAdr + i + <span class="hljs-number">2</span>) == <span class="hljs-number">0x5</span>)<br>					&#123;<br><br>						<span class="hljs-type">int</span> jmpadr = *(<span class="hljs-type">int</span>*)(pSymAdr + i + <span class="hljs-number">3</span>);<br>						jmpadr = jmpadr + <span class="hljs-number">7</span>;<br>						lpDestCall = jmpadr + pSymAdr + i;<br>						lpszCFile = <span class="hljs-built_in">CharToWchar</span>((<span class="hljs-type">char</span>*)lpDestCall);<br>						<span class="hljs-built_in">wprintf</span>(<span class="hljs-string">L&quot;Find:%ws %ws\r\n&quot;</span>, lpszFilePath, lpszCFile);<br>						<span class="hljs-keyword">break</span>;<br>					&#125;<br>				&#125;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>				<span class="hljs-built_in">FreeLibrary</span>(hModuleBase);<br><br>			&#125;<br>			<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (fd.dwFileAttributes &amp; FILE_ATTRIBUTE_DIRECTORY)<br>			&#123;<br>				<span class="hljs-keyword">if</span> (<span class="hljs-built_in">StrCmpCW</span>(fd.cFileName, <span class="hljs-string">L&quot;.&quot;</span>) != <span class="hljs-number">0</span> &amp;&amp; <span class="hljs-built_in">StrCmpCW</span>(fd.cFileName, <span class="hljs-string">L&quot;..&quot;</span>) != <span class="hljs-number">0</span>)<br>				&#123;<br>					<span class="hljs-comment">// 构造子目录的路径</span><br>					TCHAR subDirectory[MAX_PATH];<br>					<span class="hljs-built_in">StringCbCopy</span>(subDirectory, MAX_PATH, Path);<br>					<span class="hljs-built_in">StringCbCat</span>(subDirectory, MAX_PATH, <span class="hljs-string">L&quot;\\&quot;</span>);<br>					<span class="hljs-built_in">StringCbCat</span>(subDirectory, MAX_PATH, fd.cFileName);<br><br>					<span class="hljs-comment">// 递归调用FindAllDlls</span><br>					<span class="hljs-keyword">if</span> (ENEABLE_DEEP_CALL)<br>					&#123;<br>						<span class="hljs-built_in">FindAllDlls</span>(subDirectory, iDeep + <span class="hljs-number">1</span>);<br>					&#125;<br>				&#125;<br>			&#125;<br>		&#125;<br>	&#125; <span class="hljs-keyword">while</span> (<span class="hljs-built_in">FindNextFile</span>(hFind, &amp;fd));<br><br>	<span class="hljs-built_in">FindClose</span>(hFind);<br>&#125;<br><br><span class="hljs-function">BOOL <span class="hljs-title">EnableXXXPrivilege</span><span class="hljs-params">(LPCTSTR pszPrivilegeName)</span></span><br><span class="hljs-function"></span>&#123;<br>	HANDLE hToken;<br>	LUID seXXXNameValue;<br>	TOKEN_PRIVILEGES tkp;<br><br>	<span class="hljs-comment">// enable the SeXXXPrivilege</span><br>	<span class="hljs-keyword">if</span> (!<span class="hljs-built_in">OpenProcessToken</span>(<span class="hljs-built_in">GetCurrentProcess</span>(),<br>		TOKEN_ADJUST_PRIVILEGES | TOKEN_QUERY, &amp;hToken))<br>	&#123;<br>		<span class="hljs-built_in">wprintf</span>(<span class="hljs-string">L&quot;OpenProcessToken() failed, Error = %d  %s is not available.\n&quot;</span>, <span class="hljs-built_in">GetLastError</span>(), pszPrivilegeName);<br>		<span class="hljs-keyword">return</span> FALSE;<br>	&#125;<br><br>	<span class="hljs-keyword">if</span> (!<span class="hljs-built_in">LookupPrivilegeValue</span>(<span class="hljs-literal">NULL</span>, pszPrivilegeName, &amp;seXXXNameValue))<br>	&#123;<br>		<span class="hljs-built_in">wprintf</span>(<span class="hljs-string">L&quot;LookupPrivilegeValue() failed, Error = %d %s is not available.\n&quot;</span>, <span class="hljs-built_in">GetLastError</span>(), pszPrivilegeName);<br>		<span class="hljs-built_in">CloseHandle</span>(hToken);<br>		<span class="hljs-keyword">return</span> FALSE;<br>	&#125;<br><br>	tkp.PrivilegeCount = <span class="hljs-number">1</span>;<br>	tkp.Privileges[<span class="hljs-number">0</span>].Luid = seXXXNameValue;<br>	tkp.Privileges[<span class="hljs-number">0</span>].Attributes = SE_PRIVILEGE_ENABLED;<br><br>	<span class="hljs-keyword">if</span> (!<span class="hljs-built_in">AdjustTokenPrivileges</span>(hToken, FALSE, &amp;tkp, <span class="hljs-keyword">sizeof</span> tkp, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>))<br>	&#123;<br>		<span class="hljs-built_in">wprintf</span>(<span class="hljs-string">L&quot;AdjustTokenPrivileges() failed, Error = %d %s is not available.\n&quot;</span>, <span class="hljs-built_in">GetLastError</span>(), pszPrivilegeName);<br>		<span class="hljs-built_in">CloseHandle</span>(hToken);<br>		<span class="hljs-keyword">return</span> FALSE;<br>	&#125;<br><br>	<span class="hljs-built_in">CloseHandle</span>(hToken);<br><br>	<span class="hljs-keyword">return</span> TRUE;<br>&#125;<br><br><span class="hljs-comment">// 将wstring转换成string</span><br><span class="hljs-function">string <span class="hljs-title">wstring2string</span><span class="hljs-params">(wstring wstr)</span></span><br><span class="hljs-function"></span>&#123;<br>	string result;<br>	<span class="hljs-comment">//获取缓冲区大小，并申请空间，缓冲区大小事按字节计算的  </span><br>	<span class="hljs-type">int</span> len = <span class="hljs-built_in">WideCharToMultiByte</span>(CP_ACP, <span class="hljs-number">0</span>, wstr.<span class="hljs-built_in">c_str</span>(), wstr.<span class="hljs-built_in">size</span>(), <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);<br>	<span class="hljs-type">char</span>* buffer = <span class="hljs-keyword">new</span> <span class="hljs-type">char</span>[len + <span class="hljs-number">1</span>];<br>	<span class="hljs-comment">//宽字节编码转换成多字节编码  </span><br>	<span class="hljs-built_in">WideCharToMultiByte</span>(CP_ACP, <span class="hljs-number">0</span>, wstr.<span class="hljs-built_in">c_str</span>(), wstr.<span class="hljs-built_in">size</span>(), buffer, len, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);<br>	buffer[len] = <span class="hljs-string">&#x27;\0&#x27;</span>;<br>	<span class="hljs-comment">//删除缓冲区并返回值  </span><br>	result.<span class="hljs-built_in">append</span>(buffer);<br>	<span class="hljs-keyword">delete</span>[] buffer;<br>	<span class="hljs-keyword">return</span> result;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">OutputToFile</span><span class="hljs-params">(std::vector&lt;std::pair&lt;wstring, wstring&gt;&gt;&amp; vec)</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-function">ofstream <span class="hljs-title">outfile</span><span class="hljs-params">(<span class="hljs-string">&quot;output.txt&quot;</span>)</span></span>;<br><br>	<span class="hljs-keyword">if</span> (!outfile.<span class="hljs-built_in">is_open</span>()) &#123;<br>		std::cerr &lt;&lt; <span class="hljs-string">&quot;无法打开文件&quot;</span> &lt;&lt; std::endl;<br>		<span class="hljs-keyword">return</span>;<br>	&#125;<br><br>	<span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> res : g_FindReslt)<br>	&#123;<br>		outfile &lt;&lt; <span class="hljs-built_in">wstring2string</span>(res.first) &lt;&lt; <span class="hljs-string">&quot;\t&quot;</span> &lt;&lt; <span class="hljs-built_in">wstring2string</span>(res.second) &lt;&lt; endl;<br>	&#125;<br><br>	<span class="hljs-comment">// 关闭文件</span><br>	outfile.<span class="hljs-built_in">close</span>();<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span>* argv[])</span></span><br><span class="hljs-function"></span>&#123;<br>	PVOID OldValue;<br>	<span class="hljs-keyword">if</span> (<span class="hljs-built_in">Wow64DisableWow64FsRedirection</span>(&amp;OldValue))<br>		std::cout &lt;&lt; <span class="hljs-string">&quot;File system redirection disabled.&quot;</span> &lt;&lt; std::endl;<br>	wcout &lt;&lt; WHITE &lt;&lt; endl;<br><br>	<span class="hljs-built_in">EnableXXXPrivilege</span>(SE_DEBUG_NAME);<br><br>	<span class="hljs-keyword">if</span> (!<span class="hljs-built_in">SymInitializeW</span>(<span class="hljs-built_in">GetCurrentProcess</span>(), <span class="hljs-literal">NULL</span>, FALSE))<br>	&#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>	&#125;<br><br>	DWORD dwSymOpt = <span class="hljs-built_in">SymGetOptions</span>();<br><br>	<span class="hljs-type">int</span> iDeep = <span class="hljs-number">0</span>;<br>	<span class="hljs-built_in">FindAllDlls</span>(ENUM_PATH, iDeep);<br><br>	cout &lt;&lt; endl&lt;&lt; endl;<br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	for (auto res : g_FindReslt)</span><br><span class="hljs-comment">	&#123;</span><br><span class="hljs-comment">		wcout &lt;&lt; RED &lt;&lt; res.first &lt;&lt; &quot;\t&quot; &lt;&lt; res.second &lt;&lt; endl;</span><br><span class="hljs-comment">	&#125;</span><br><span class="hljs-comment">	*/</span><br><br>	wcout &lt;&lt; WHITE &lt;&lt; endl;<br>	<br>	<span class="hljs-comment">// 重新启用文件系统重定向</span><br>	<span class="hljs-keyword">if</span> (<span class="hljs-built_in">Wow64RevertWow64FsRedirection</span>(OldValue)) &#123;<br>		std::cout &lt;&lt; <span class="hljs-string">&quot;File system redirection re-enabled.&quot;</span> &lt;&lt; std::endl;<br>	&#125;<br>	<span class="hljs-keyword">else</span> &#123;<br>		std::cerr &lt;&lt; <span class="hljs-string">&quot;Failed to re-enable file system redirection.&quot;</span> &lt;&lt; std::endl;<br>	&#125;<br><br>	<span class="hljs-built_in">OutputToFile</span>(g_FindReslt);<br><br>	<span class="hljs-comment">// 程序执行完成后，将控制台窗口置顶</span><br>	HWND consoleWindow = <span class="hljs-built_in">GetConsoleWindow</span>(); <span class="hljs-comment">// 获取控制台窗口句柄</span><br>	<span class="hljs-built_in">ShowWindow</span>(consoleWindow, SW_SHOW); <span class="hljs-comment">// 显示控制台窗口</span><br>	<span class="hljs-built_in">SetForegroundWindow</span>(consoleWindow); <span class="hljs-comment">// 将控制台窗口置顶</span><br><br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
                
              </div>
            
            <hr>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/A-OS/" class="category-chain-item">A_OS</a>
  
  
    <span>></span>
    
  <a href="/categories/A-OS/Windows/" class="category-chain-item">Windows</a>
  
  
    <span>></span>
    
  <a href="/categories/A-OS/Windows/DbgHelp/" class="category-chain-item">DbgHelp</a>
  
  

  

  

      </span>
    
  
</span>

    </div>
  
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>【DbgHelp】通过PDB在PE中查找函数</div>
      <div>https://hodlyounger.github.io/A_OS/Windows/DbgHelp/【DbgHelp】通过PDB在PE中查找函数/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>mingming</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2024年8月12日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/" rel="external nofollow noopener noreferrer">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-cc-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/A_OS/Windows/%E5%BC%82%E5%B8%B8%E5%8F%8A%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86/%E3%80%90%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E3%80%91WPD%E9%A9%B1%E5%8A%A8%E5%BC%82%E5%B8%B8/" title="【异常处理】WPD驱动异常">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">【异常处理】WPD驱动异常</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/A_OS/Windows/PnP/%E3%80%90PnP%E3%80%91CodeCollect/" title="【PnP】 CodeCollections">
                        <span class="hidden-mobile">【PnP】 CodeCollections</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="external nofollow noopener noreferrer"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="external nofollow noopener noreferrer"><span>Fluid</span></a> 
    </div>
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js"></script>
  <link rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css">

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js"></script>
<script src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js"></script>
<script src="/js/events.js"></script>
<script src="/js/plugins.js"></script>


  <script src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js"></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script src="/js/img-lazyload.js"></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src="https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js"></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/5.0.0/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script src="/js/local-search.js"></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script src="/js/boot.js"></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
